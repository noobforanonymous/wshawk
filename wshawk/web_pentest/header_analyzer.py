import aiohttp
from typing import Dict, Any

class WSHawkHeaderAnalyzer:
    def __init__(self):
        self.sec_headers = [
            'strict-transport-security', 'content-security-policy', 'x-frame-options',
            'x-content-type-options', 'server', 'x-powered-by', 'access-control-allow-origin'
        ]

    def _evaluate_risk(self, header: str, value: str) -> Dict[str, str]:
        header = header.lower()
        if value == "Missing":
            if header in ['server', 'x-powered-by']:
                return {"value": "Missing", "risk": "Safe", "msg": "Good (Not disclosed)"}
            elif header == 'access-control-allow-origin':
                return {"value": "Missing", "risk": "Safe", "msg": "CORS restricted to origin"}
            return {"value": "Missing", "risk": "Medium", "msg": "Missing security header"}

        val_lower = value.lower()
        
        if header == 'strict-transport-security':
            if 'max-age=0' in val_lower:
                return {"value": value, "risk": "High", "msg": "HSTS is disabled (max-age=0)"}
            if 'includesubdomains' not in val_lower:
                return {"value": value, "risk": "Low", "msg": "Missing includeSubDomains directive"}
            return {"value": value, "risk": "Safe", "msg": "HSTS configured properly"}
            
        elif header == 'content-security-policy':
            if '*' in value or 'unsafe-inline' in val_lower or 'unsafe-eval' in val_lower:
                return {"value": value, "risk": "Medium", "msg": "Weak CSP configured"}
            return {"value": value, "risk": "Safe", "msg": "CSP present"}
            
        elif header == 'access-control-allow-origin':
            if value == '*':
                return {"value": value, "risk": "High", "msg": "Dangerous wildcard CORS"}
            if value == 'null':
                return {"value": value, "risk": "High", "msg": "Dangerous 'null' CORS"}
            return {"value": value, "risk": "Low", "msg": "CORS configured"}
            
        elif header in ['server', 'x-powered-by']:
            # Any disclosure is slightly risky
            return {"value": value, "risk": "Low", "msg": "Information disclosure"}
            
        elif header == 'x-frame-options':
            if val_lower not in ['deny', 'sameorigin']:
                return {"value": value, "risk": "Medium", "msg": "Weak X-Frame-Options"}
            return {"value": value, "risk": "Safe", "msg": "Clickjacking mitigated"}

        return {"value": value, "risk": "Info", "msg": "Present"}

    async def analyze(self, url: str) -> Dict[str, Any]:
        """Analyzes HTTP security headers and evaluates risk for a given URL."""
        if not url:
            raise ValueError("URL required")
        url = url.strip()
        if not url.startswith(("http://", "https://")):
            url = "https://" + url
            
        async with aiohttp.ClientSession() as session:
            async with session.get(url, ssl=False, allow_redirects=True, timeout=10) as resp:
                headers = {k.lower(): v for k, v in resp.headers.items()}
            
            out = {}
            for h in self.sec_headers:
                raw_val = headers.get(h, "Missing")
                out[h] = self._evaluate_risk(h, raw_val)
                    
            return out

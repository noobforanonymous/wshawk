"""
WSHawk Report Forge
Generates professional, print-ready HTML security assessment reports
with executive summary, severity breakdown, detailed findings,
remediation guidance, and all module results.
"""

import json
import os
import time
import platform
from typing import Dict, Any, List
from datetime import datetime

WSHAWK_VERSION = "3.0.1"


class WSHawkReportGenerator:
    """
    Generates comprehensive security assessment reports.

    Produces self-contained HTML reports styled for professional
    presentation and browser-to-PDF printing. Reports include:
        - Executive summary with risk scoring
        - Severity breakdown chart (CSS-only, no JS deps)
        - Detailed findings with remediation guidance
        - Module-specific result sections
        - Target information and scan metadata
    """

    def __init__(self, output_dir: str = "/tmp/wshawk_reports"):
        self.output_dir = output_dir
        os.makedirs(output_dir, exist_ok=True)

    def generate_json(self, report_data: Dict) -> str:
        """Export findings to a structured JSON file."""
        ts = datetime.now().strftime("%Y%m%d_%H%M%S")
        target_clean = _clean_target(report_data.get("target", "unknown"))
        filename = f"wshawk_{target_clean}_{ts}.json"
        filepath = os.path.join(self.output_dir, filename)

        with open(filepath, 'w') as f:
            json.dump(report_data, f, indent=2, default=str)

        return filepath

    def generate_html(self, report_data: Dict) -> str:
        """Generate a professional, print-ready HTML security report."""
        ts = datetime.now().strftime("%Y%m%d_%H%M%S")
        now_display = datetime.now().strftime('%Y-%m-%d %H:%M:%S')
        target = report_data.get("target", "Unknown")
        target_clean = _clean_target(target)

        filename = f"wshawk_{target_clean}_{ts}.html"
        filepath = os.path.join(self.output_dir, filename)

        findings = report_data.get("findings", [])
        severity_counts = report_data.get("severity_counts", {})
        elapsed = report_data.get("elapsed", 0)
        modules_used = report_data.get("modules_used", [])

        # Calculate risk score
        high = severity_counts.get("High", 0)
        medium = severity_counts.get("Medium", 0)
        low = severity_counts.get("Low", 0)
        info = severity_counts.get("Info", 0)
        total = high + medium + low + info

        risk_score = min(100, high * 25 + medium * 10 + low * 3 + info * 1)
        risk_label = (
            "Critical" if risk_score >= 75 else
            "High" if risk_score >= 50 else
            "Medium" if risk_score >= 25 else
            "Low" if risk_score > 0 else "Clean"
        )
        risk_color = (
            "#ef4444" if risk_score >= 75 else
            "#f97316" if risk_score >= 50 else
            "#f59e0b" if risk_score >= 25 else
            "#22c55e"
        )

        # Severity bar percentages
        total_max = max(total, 1)
        high_pct = (high / total_max) * 100
        med_pct = (medium / total_max) * 100
        low_pct = (low / total_max) * 100
        info_pct = (info / total_max) * 100

        # Build findings HTML + TOC entries
        findings_html = ""
        toc_html = ""
        for i, f in enumerate(findings, 1):
            sev = f.get("severity", "Info")
            sev_color = _sev_color(sev)
            title = _esc(f.get("title", "Untitled"))
            detail = _esc(f.get("detail", ""))
            url = _esc(f.get("url", ""))
            remediation = _esc(f.get("remediation", ""))
            evidence = _esc(f.get("evidence", ""))
            anchor_id = f"finding-{i}"

            toc_html += f'<div style="display:flex;gap:8px;align-items:center;padding:4px 0;font-size:12px;"><span class="sev-badge" style="background:{sev_color};font-size:9px;padding:1px 6px;">#{i}</span><a href="#{anchor_id}" style="color:var(--text);text-decoration:none;">{title}</a></div>\n'

            findings_html += f"""
            <div class="finding" id="{anchor_id}">
                <div class="finding-header">
                    <span class="finding-id">#{i}</span>
                    <span class="sev-badge" style="background:{sev_color};">{sev}</span>
                    <span class="finding-title">{title}</span>
                </div>
                <div class="finding-body">
                    <div class="finding-detail">{detail}</div>
                    {'<div class="finding-url"><strong>Affected URL:</strong> <code>' + url + '</code></div>' if url else ''}
                    {'<div class="finding-evidence"><strong>Evidence:</strong><pre>' + evidence + '</pre></div>' if evidence else ''}
                    {'<div class="finding-remediation"><strong>Remediation:</strong> ' + remediation + '</div>' if remediation else ''}
                </div>
            </div>"""

        # Module results
        extra_sections = report_data.get("sections", {})
        extra_html = ""
        for section_name, section_data in extra_sections.items():
            extra_html += f"""
            <div class="section">
                <h2>{_esc(section_name)}</h2>
                <div class="section-content">
                    <pre>{_esc(json.dumps(section_data, indent=2, default=str)[:3000])}</pre>
                </div>
            </div>"""

        html = f"""<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WSHawk Security Report — {_esc(target)}</title>
<style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

    * {{ margin: 0; padding: 0; box-sizing: border-box; }}

    :root {{
        --bg: #0a0a12;
        --bg-card: #11111b;
        --bg-card-alt: #161625;
        --text: #e2e8f0;
        --text-muted: #64748b;
        --border: #1e293b;
        --accent: #06b6d4;
        --danger: #ef4444;
        --warning: #f59e0b;
        --safe: #22c55e;
        --blue: #3b82f6;
    }}

    body {{
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        background: var(--bg);
        color: var(--text);
        line-height: 1.6;
    }}

    .report {{
        max-width: 900px;
        margin: 0 auto;
        padding: 40px 30px;
    }}

    /* ─── Header ─── */
    .report-header {{
        text-align: center;
        padding-bottom: 30px;
        border-bottom: 1px solid var(--border);
        margin-bottom: 30px;
    }}
    .brand {{
        font-size: 11px;
        letter-spacing: 4px;
        text-transform: uppercase;
        color: var(--accent);
        margin-bottom: 8px;
    }}
    .report-header h1 {{
        font-size: 28px;
        font-weight: 700;
        margin-bottom: 6px;
    }}
    .report-header .meta {{
        color: var(--text-muted);
        font-size: 12px;
    }}
    .report-header .meta span {{
        margin: 0 8px;
    }}

    /* ─── Executive Summary ─── */
    .exec-summary {{
        display: grid;
        grid-template-columns: 200px 1fr;
        gap: 24px;
        margin-bottom: 30px;
        background: var(--bg-card);
        padding: 24px;
        border-radius: 12px;
        border: 1px solid var(--border);
    }}
    .risk-circle {{
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }}
    .risk-score {{
        width: 120px;
        height: 120px;
        border-radius: 50%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        border: 4px solid {risk_color};
        background: rgba({_hex_to_rgb(risk_color)}, 0.1);
    }}
    .risk-score .number {{
        font-size: 36px;
        font-weight: 700;
        color: {risk_color};
        line-height: 1;
    }}
    .risk-score .label {{
        font-size: 10px;
        text-transform: uppercase;
        letter-spacing: 1px;
        color: {risk_color};
        margin-top: 4px;
    }}
    .risk-label {{
        margin-top: 8px;
        font-size: 13px;
        font-weight: 600;
        color: {risk_color};
    }}
    .exec-details {{
        display: flex;
        flex-direction: column;
        justify-content: center;
    }}
    .exec-details h2 {{
        font-size: 16px;
        margin-bottom: 12px;
        color: var(--text);
    }}
    .exec-details p {{
        font-size: 13px;
        color: var(--text-muted);
        line-height: 1.7;
    }}

    /* ─── Severity Cards ─── */
    .severity-bar {{
        display: flex;
        gap: 8px;
        margin-bottom: 30px;
    }}
    .sev-card {{
        flex: 1;
        background: var(--bg-card);
        padding: 16px;
        border-radius: 10px;
        text-align: center;
        border: 1px solid var(--border);
        transition: transform 0.2s;
    }}
    .sev-card:hover {{
        transform: translateY(-2px);
    }}
    .sev-card .count {{
        font-size: 32px;
        font-weight: 700;
        line-height: 1;
    }}
    .sev-card .name {{
        font-size: 10px;
        text-transform: uppercase;
        letter-spacing: 1.5px;
        color: var(--text-muted);
        margin-top: 6px;
    }}
    .sev-card.high .count {{ color: var(--danger); }}
    .sev-card.medium .count {{ color: var(--warning); }}
    .sev-card.low .count {{ color: var(--blue); }}
    .sev-card.info .count {{ color: var(--text-muted); }}

    /* ─── Severity Distribution Bar ─── */
    .dist-bar {{
        height: 8px;
        background: var(--bg-card);
        border-radius: 4px;
        overflow: hidden;
        display: flex;
        margin-bottom: 30px;
    }}
    .dist-bar .seg {{
        height: 100%;
        transition: width 0.5s ease;
    }}
    .dist-bar .seg.high {{ background: var(--danger); }}
    .dist-bar .seg.medium {{ background: var(--warning); }}
    .dist-bar .seg.low {{ background: var(--blue); }}
    .dist-bar .seg.info {{ background: #374151; }}

    /* ─── Findings ─── */
    .findings-header {{
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 16px;
        padding-bottom: 8px;
        border-bottom: 1px solid var(--border);
    }}
    .finding {{
        background: var(--bg-card);
        border-radius: 10px;
        margin-bottom: 10px;
        border: 1px solid var(--border);
        overflow: hidden;
    }}
    .finding-header {{
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 12px 16px;
        border-bottom: 1px solid var(--border);
    }}
    .finding-id {{
        font-size: 11px;
        font-weight: 600;
        color: var(--text-muted);
        min-width: 28px;
    }}
    .sev-badge {{
        padding: 2px 10px;
        border-radius: 4px;
        font-size: 10px;
        font-weight: 700;
        color: #fff;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }}
    .finding-title {{
        font-weight: 600;
        font-size: 13px;
    }}
    .finding-body {{
        padding: 14px 16px;
        font-size: 12px;
        color: var(--text-muted);
        line-height: 1.7;
    }}
    .finding-body > div {{
        margin-bottom: 8px;
    }}
    .finding-body code {{
        background: var(--bg-card-alt);
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 11px;
    }}
    .finding-body pre {{
        background: var(--bg-card-alt);
        padding: 10px;
        border-radius: 6px;
        font-size: 11px;
        overflow-x: auto;
        margin-top: 6px;
    }}
    .finding-remediation {{
        background: rgba(34, 197, 94, 0.06);
        border-left: 3px solid var(--safe);
        padding: 8px 12px;
        border-radius: 0 6px 6px 0;
        font-size: 11px;
    }}
    .finding-url {{
        font-size: 11px;
    }}
    .finding-evidence {{
        font-size: 11px;
    }}

    /* ─── Sections ─── */
    .section {{
        margin-top: 24px;
    }}
    .section h2 {{
        font-size: 16px;
        margin-bottom: 12px;
        padding-bottom: 8px;
        border-bottom: 1px solid var(--border);
    }}
    .section-content pre {{
        background: var(--bg-card);
        padding: 16px;
        border-radius: 8px;
        font-size: 11px;
        overflow-x: auto;
        border: 1px solid var(--border);
    }}

    /* ─── Metadata ─── */
    .scan-meta {{
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 8px;
        margin-bottom: 30px;
        background: var(--bg-card);
        padding: 16px;
        border-radius: 10px;
        border: 1px solid var(--border);
        font-size: 12px;
    }}
    .scan-meta .item {{
        display: flex;
        gap: 8px;
    }}
    .scan-meta .item .key {{
        color: var(--text-muted);
        min-width: 80px;
    }}
    .scan-meta .item .val {{
        font-weight: 500;
        font-family: 'Inter', monospace;
    }}

    /* ─── Footer ─── */
    .report-footer {{
        margin-top: 40px;
        padding-top: 20px;
        border-top: 1px solid var(--border);
        text-align: center;
        font-size: 11px;
        color: var(--text-muted);
    }}
    .report-footer .brand-footer {{
        color: var(--accent);
        font-weight: 600;
    }}

    /* ─── Print Styles ─── */
    @media print {{
        body {{ background: #fff; color: #111; }}
        .report {{ padding: 20px 10px; }}
        .exec-summary, .sev-card, .finding, .scan-meta, .section-content pre {{
            background: #f8fafc;
            border-color: #e2e8f0;
            color: #111;
        }}
        .finding-body {{ color: #334155; }}
        .report-header h1 {{ color: #111; }}
        .brand {{ color: #0891b2; }}
    }}
</style>
</head>
<body>
<div class="report">

    <!-- Header -->
    <div class="report-header">
        <div class="brand">▸ WSHawk Security Assessment</div>
        <h1>Penetration Test Report</h1>
        <div class="meta">
            <span>Target: <strong>{_esc(target)}</strong></span>
            <span>·</span>
            <span>{now_display}</span>
            <span>·</span>
            <span>Duration: {elapsed}s</span>
        </div>
    </div>

    <!-- Scan Metadata -->
    <div class="scan-meta">
        <div class="item"><span class="key">Target</span><span class="val">{_esc(target)}</span></div>
        <div class="item"><span class="key">Date</span><span class="val">{now_display}</span></div>
        <div class="item"><span class="key">Duration</span><span class="val">{elapsed}s</span></div>
        <div class="item"><span class="key">Findings</span><span class="val">{total}</span></div>
        <div class="item"><span class="key">Modules</span><span class="val">{', '.join(modules_used) if modules_used else 'All'}</span></div>
        <div class="item"><span class="key">Risk Score</span><span class="val" style="color:{risk_color};">{risk_score}/100 ({risk_label})</span></div>
        <div class="item"><span class="key">WSHawk</span><span class="val">v{WSHAWK_VERSION}</span></div>
        <div class="item"><span class="key">Platform</span><span class="val">{platform.system()} {platform.release()}</span></div>
        <div class="item"><span class="key">Python</span><span class="val">{platform.python_version()}</span></div>
    </div>

    <!-- Executive Summary -->
    <div class="exec-summary">
        <div class="risk-circle">
            <div class="risk-score">
                <div class="number">{risk_score}</div>
                <div class="label">Risk Score</div>
            </div>
            <div class="risk-label">{risk_label} Risk</div>
        </div>
        <div class="exec-details">
            <h2>Executive Summary</h2>
            <p>
                Security assessment of <strong>{_esc(target)}</strong> identified
                <strong>{total}</strong> finding{'s' if total != 1 else ''},
                including <strong style="color:var(--danger);">{high} high</strong>,
                <strong style="color:var(--warning);">{medium} medium</strong>,
                <strong style="color:var(--blue);">{low} low</strong>, and
                <strong>{info} informational</strong> severity issues.
                {'Immediate remediation is recommended for all High severity findings.' if high > 0 else ''}
                {'Medium severity issues should be addressed in the next release cycle.' if medium > 0 else ''}
                {'No critical vulnerabilities were identified.' if high == 0 and medium == 0 else ''}
            </p>
        </div>
    </div>

    <!-- Severity Cards -->
    <div class="severity-bar">
        <div class="sev-card high"><div class="count">{high}</div><div class="name">High</div></div>
        <div class="sev-card medium"><div class="count">{medium}</div><div class="name">Medium</div></div>
        <div class="sev-card low"><div class="count">{low}</div><div class="name">Low</div></div>
        <div class="sev-card info"><div class="count">{info}</div><div class="name">Info</div></div>
    </div>

    <!-- Distribution Bar -->
    <div class="dist-bar">
        <div class="seg high" style="width:{high_pct}%;"></div>
        <div class="seg medium" style="width:{med_pct}%;"></div>
        <div class="seg low" style="width:{low_pct}%;"></div>
        <div class="seg info" style="width:{info_pct}%;"></div>
    </div>

    <!-- Findings -->
    <!-- Table of Contents -->
    {f'''<div style="background:var(--bg-card);border:1px solid var(--border);border-radius:10px;padding:16px;margin-bottom:20px;">
        <div style="font-size:14px;font-weight:600;margin-bottom:10px;">Table of Contents</div>
        {toc_html}
    </div>''' if toc_html else ''}

    <!-- Findings -->
    <div class="findings-header">Detailed Findings ({total})</div>
    {findings_html if findings_html else '<div style="text-align:center;color:var(--text-muted);padding:40px;">No vulnerabilities identified. Target appears secure against tested vectors.</div>'}

    <!-- Extra Sections -->
    {extra_html}

    <!-- Footer -->
    <div class="report-footer">
        <span class="brand-footer">WSHawk</span> Security Assessment Report
        · Generated {now_display}
        · This report is confidential
    </div>

</div>
</body>
</html>"""

        with open(filepath, 'w') as f:
            f.write(html)

        return filepath

    def generate_pdf(self, report_data: Dict) -> str:
        """
        Generate a PDF security report using WeasyPrint.

        First generates the HTML report, then converts it to PDF.
        Returns the path to the PDF file.
        """
        # Generate HTML first
        html_path = self.generate_html(report_data)

        # Convert to PDF
        ts = datetime.now().strftime("%Y%m%d_%H%M%S")
        target_clean = _clean_target(report_data.get("target", "unknown"))
        pdf_filename = f"wshawk_{target_clean}_{ts}.pdf"
        pdf_path = os.path.join(self.output_dir, pdf_filename)

        try:
            from weasyprint import HTML
            HTML(filename=html_path).write_pdf(pdf_path)
            return pdf_path
        except ImportError:
            raise RuntimeError(
                "WeasyPrint is not installed. Run: pip install weasyprint"
            )
        except Exception as e:
            raise RuntimeError(f"PDF generation failed: {str(e)}")

    @staticmethod
    def get_scan_metadata() -> Dict[str, str]:
        """Get system and version metadata for reports."""
        return {
            "wshawk_version": WSHAWK_VERSION,
            "python_version": platform.python_version(),
            "os": f"{platform.system()} {platform.release()}",
            "hostname": platform.node(),
            "timestamp": datetime.now().isoformat(),
        }


def _clean_target(target: str) -> str:
    """Clean target name for use in filenames."""
    return (target
            .replace("https://", "")
            .replace("http://", "")
            .replace("/", "_")
            .replace(":", "_")
            .replace("?", "_"))


def _esc(text) -> str:
    """Basic HTML escaping."""
    if not isinstance(text, str):
        text = str(text)
    return (text
            .replace("&", "&amp;")
            .replace("<", "&lt;")
            .replace(">", "&gt;")
            .replace('"', "&quot;"))


def _sev_color(sev: str) -> str:
    """Get color for severity level."""
    return {
        "Critical": "#dc2626",
        "High": "#ef4444",
        "Medium": "#f59e0b",
        "Low": "#3b82f6",
        "Info": "#6b7280",
    }.get(sev, "#6b7280")


def _hex_to_rgb(hex_color: str) -> str:
    """Convert #rrggbb to 'r, g, b' for rgba()."""
    h = hex_color.lstrip("#")
    return f"{int(h[0:2], 16)}, {int(h[2:4], 16)}, {int(h[4:6], 16)}"
